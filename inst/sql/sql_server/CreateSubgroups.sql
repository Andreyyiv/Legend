/************************************************************************
Copyright 2018 Observational Health Data Sciences and Informatics

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
************************************************************************/
--subgroups of interest
--1.  renal impairment
--2.  hepatic impairment
--3.  pregnant women
--4.  children (age<18)
--5.  elderly (age >= 65)
--6.  male
--7.  Type 2 diabetes mellitus
--8.  Black or African American
{DEFAULT @cdm_database_schema = 'cdm.dbo'}
{DEFAULT @window_end = 0}
{DEFAULT @window_start = -365}
{DEFAULT @analysis_id = 998}
{DEFAULT @cohort_id = -1}
{DEFAULT @row_id_field = 'row_id'}
{DEFAULT @cohort_temp_table = '#cohort'}

IF OBJECT_ID('tempdb..#cov_1', 'U') IS NOT NULL
	DROP TABLE #cov_1;

IF OBJECT_ID('tempdb..#cov_2', 'U') IS NOT NULL
	DROP TABLE #cov_2;

IF OBJECT_ID('tempdb..#cov_3', 'U') IS NOT NULL
	DROP TABLE #cov_3;

IF OBJECT_ID('tempdb..#cov_4', 'U') IS NOT NULL
	DROP TABLE #cov_4;

IF OBJECT_ID('tempdb..#cov_5', 'U') IS NOT NULL
	DROP TABLE #cov_5;

IF OBJECT_ID('tempdb..#cov_6', 'U') IS NOT NULL
	DROP TABLE #cov_6;
	
IF OBJECT_ID('tempdb..#cov_7', 'U') IS NOT NULL
	DROP TABLE #cov_7;

IF OBJECT_ID('tempdb..#cov_8', 'U') IS NOT NULL
	DROP TABLE #cov_8;
	
--1.  renal impairment
SELECT DISTINCT row_id,
	CAST(1000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_1
FROM (
	SELECT DISTINCT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.condition_occurrence co
		ON c.subject_id = co.person_id
			AND co.condition_start_date <= DATEADD(DAY, @window_end, c.cohort_start_date)
			AND co.condition_start_date >= DATEADD(DAY, @window_start, c.cohort_start_date)
{@cohort_id != -1} ? {			AND c.cohort_definition_id = @cohort_id}
			AND co.condition_concept_id IN (
				SELECT descendant_concept_id
				FROM @cdm_database_schema.concept_ancestor
				WHERE ancestor_concept_id IN (45889365, 2786488, 2788041, 4032243, 4090651, 4030518) /*concepts for renal impairment and associated dialysis findings*/
				)
	
	UNION
	
	SELECT DISTINCT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.procedure_occurrence po
		ON c.subject_id = po.person_id
			AND po.procedure_date <= DATEADD(DAY, @window_end, c.cohort_start_date)
			AND po.procedure_date >= DATEADD(DAY, @window_start, c.cohort_start_date)
{@cohort_id != -1} ? {			AND c.cohort_definition_id = @cohort_id}
			AND po.procedure_concept_id IN (
				SELECT descendant_concept_id
				FROM @cdm_database_schema.concept_ancestor
				WHERE ancestor_concept_id IN (45889365, 2786488, 2788041, 4032243, 4090651, 4030518) /*concepts for renal impairment and associated dialysis findings*/
				)
	
	UNION
	
	SELECT DISTINCT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.observation o
		ON c.subject_id = o.person_id
			AND o.observation_date <= DATEADD(DAY, @window_end, c.cohort_start_date)
			AND o.observation_date >= DATEADD(DAY, @window_start, c.cohort_start_date)
{@cohort_id != -1} ? {			AND c.cohort_definition_id = @cohort_id}
			AND o.observation_concept_id IN (
				SELECT descendant_concept_id
				FROM @cdm_database_schema.concept_ancestor
				WHERE ancestor_concept_id IN (45889365, 2786488, 2788041, 4032243, 4090651, 4030518) /*concepts for renal impairment and associated dialysis findings*/
				)
	) tmp;

--2.  hepatic impairment
SELECT DISTINCT row_id,
	CAST(2000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_2
FROM (
	SELECT DISTINCT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.condition_occurrence co
		ON c.subject_id = co.person_id
			AND co.condition_start_date <= DATEADD(DAY, @window_end, c.cohort_start_date)
			AND co.condition_start_date >= DATEADD(DAY, @window_start, c.cohort_start_date)
{@cohort_id != -1} ? {			AND c.cohort_definition_id = @cohort_id}
			AND co.condition_concept_id IN (
				SELECT descendant_concept_id
				FROM @cdm_database_schema.concept_ancestor
				WHERE ancestor_concept_id IN (4245975, 200763, 4064161, 4337543, 4055224) /*concepts for hepatic failure, chronic hepatitis, cirrhosis of liver, hepatic necrosis, toxic liver disease*/
				)
	) tmp;

--3.  pregnant women
--find women
--with pregancy start in 9mo prior to index
--and no pregnancy outcome after pregnancy start and prior to index
--and pregancy outcome in 9mo after index
SELECT DISTINCT row_id,
	CAST(3000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_3
FROM (
	SELECT t1.row_id
	FROM (
		SELECT @row_id_field AS row_id
		FROM @cohort_temp_table c
		INNER JOIN @cdm_database_schema.person p
			ON c.subject_id = p.person_id
				AND p.gender_concept_id = 8532
{@cohort_id != -1} ? {		WHERE c.cohort_definition_id = @cohort_id}
		) t1
	INNER JOIN (
		SELECT row_id,
			MAX(preg_event_date) AS preg_event_date
		FROM (
			SELECT @row_id_field AS row_id,
				co.condition_start_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.condition_occurrence co
				ON c.subject_id = co.person_id
					AND co.condition_start_date <= c.cohort_start_date
					AND co.condition_start_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND co.condition_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								72693, 72696, 72973, 73268, 73282, 75639, 76491, 76756, 77338, 77619, 78210, 78218, 79091, 79146, 79890, 80165, 80204, 80205, 80463, 81358, 81360, 81636, 133284, 135370, 139895, 192380, 192385, 193525, 193825, 194598, 195877, 197050, 198212, 201091, 201958, 258564, 313590, 314099, 315884, 375016, 432969, 433027, 433603, 433880, 434697, 435875, 435887, 436219, 437041, 437090, 437341, 437937, 439656, 440162, 440216, 441092, 441682, 441926, 441959, 442088, 442772, 443213, 443214, 443295, 2004764, 2004822, 2004823, 2004824, 2100998, 2101804, 2110280, 2110284, 2110285, 2110288, 2110304, 2110305, 2110337, 2110340, 2211758, 2211759, 2211760, 2211761, 2211782, 2211785, 2212094, 2212144, 2212145, 2212210, 2212334, 2212391, 2212436, 2212438, 2212439, 2212713, 2212714, 2213361, 2213362, 2213363, 2213364, 2213365, 3000119, 3002091, 3003191, 3003262, 3003694, 3004303, 3005625, 3006511, 3006722, 3008714, 3009417, 3010164, 3011149, 3011465, 3011536, 3011996, 3013297, 3014064, 3017439, 3018171, 3018954, 3019145, 3021584, 3023524, 3023791, 3025455, 3025994, 3030662, 3034139, 3035904, 3036988, 
								3038136, 3040000, 3044819, 3045823, 3051741, 4014290, 4015137, 4015139, 4015159, 4015304, 4015590, 4016059, 4023420, 4030415, 4034308, 4038424, 4038571, 4038573, 4038747, 4038759, 4038937, 4038938, 4038939, 4038942, 4038945, 4039088, 4039609, 4039610, 4041161, 4047845, 4053583, 4057149, 4058246, 4059050, 4059478, 4059984, 4060098, 4060105, 4060240, 4060252, 4060255, 4060259, 4060424, 4060672, 4061154, 4061411, 4061423, 4061522, 4061530, 4061672, 4061791, 4061793, 4061795, 4062361, 4062565, 4064169, 4064277, 4064854, 4066111, 4066354, 4070303, 4071437, 4072421, 4072862, 4079751, 4079835, 4079844, 4080059, 4080067, 4081196, 4081292, 4083415, 4084186, 4084521, 4084693, 4087235, 4092289, 4094910, 4098631, 4120817, 4120986, 4127104, 4127241, 4129023, 4130310, 4133029, 4140250, 4143204, 4143646, 4145315, 4146482, 4147941, 4148890, 4149370, 4149783, 4150421, 4150948, 4151190, 4151412, 4156955, 4163851, 4171428, 4173786, 4175225, 4176966, 4186424, 4190427, 4194143, 4199599, 4199931, 4207466, 4210896, 4212260, 4214930, 4218813, 4232703, 4239302, 4260976, 4285271, 4299535, 4305717
								, 4327048, 4334808, 40479820, 40756825, 40758989, 40759953, 40760436, 40760833, 43022052, 43054893, 43530886, 43530888, 4014769, 4060556, 4060559
								)
						)
					AND co.condition_concept_id NOT IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (4060559, 4060556, 4014769)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}						
			
			UNION
			
			SELECT @row_id_field AS row_id,
				po.procedure_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.procedure_occurrence po
				ON c.subject_id = po.person_id
					AND po.procedure_date <= c.cohort_start_date
					AND po.procedure_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND po.procedure_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								72693, 72696, 72973, 73268, 73282, 75639, 76491, 76756, 77338, 77619, 78210, 78218, 79091, 79146, 79890, 80165, 80204, 80205, 80463, 81358, 81360, 81636, 133284, 135370, 139895, 192380, 192385, 193525, 193825, 194598, 195877, 197050, 198212, 201091, 201958, 258564, 313590, 314099, 315884, 375016, 432969, 433027, 433603, 433880, 434697, 435875, 435887, 436219, 437041, 437090, 437341, 437937, 439656, 440162, 440216, 441092, 441682, 441926, 441959, 442088, 442772, 443213, 443214, 443295, 2004764, 2004822, 2004823, 2004824, 2100998, 2101804, 2110280, 2110284, 2110285, 2110288, 2110304, 2110305, 2110337, 2110340, 2211758, 2211759, 2211760, 2211761, 2211782, 2211785, 2212094, 2212144, 2212145, 2212210, 2212334, 2212391, 2212436, 2212438, 2212439, 2212713, 2212714, 2213361, 2213362, 2213363, 2213364, 2213365, 3000119, 3002091, 3003191, 3003262, 3003694, 3004303, 3005625, 3006511, 3006722, 3008714, 3009417, 3010164, 3011149, 3011465, 3011536, 3011996, 3013297, 3014064, 3017439, 3018171, 3018954, 3019145, 3021584, 3023524, 3023791, 3025455, 3025994, 3030662, 3034139, 3035904, 3036988, 
								3038136, 3040000, 3044819, 3045823, 3051741, 4014290, 4015137, 4015139, 4015159, 4015304, 4015590, 4016059, 4023420, 4030415, 4034308, 4038424, 4038571, 4038573, 4038747, 4038759, 4038937, 4038938, 4038939, 4038942, 4038945, 4039088, 4039609, 4039610, 4041161, 4047845, 4053583, 4057149, 4058246, 4059050, 4059478, 4059984, 4060098, 4060105, 4060240, 4060252, 4060255, 4060259, 4060424, 4060672, 4061154, 4061411, 4061423, 4061522, 4061530, 4061672, 4061791, 4061793, 4061795, 4062361, 4062565, 4064169, 4064277, 4064854, 4066111, 4066354, 4070303, 4071437, 4072421, 4072862, 4079751, 4079835, 4079844, 4080059, 4080067, 4081196, 4081292, 4083415, 4084186, 4084521, 4084693, 4087235, 4092289, 4094910, 4098631, 4120817, 4120986, 4127104, 4127241, 4129023, 4130310, 4133029, 4140250, 4143204, 4143646, 4145315, 4146482, 4147941, 4148890, 4149370, 4149783, 4150421, 4150948, 4151190, 4151412, 4156955, 4163851, 4171428, 4173786, 4175225, 4176966, 4186424, 4190427, 4194143, 4199599, 4199931, 4207466, 4210896, 4212260, 4214930, 4218813, 4232703, 4239302, 4260976, 4285271, 4299535, 4305717
								, 4327048, 4334808, 40479820, 40756825, 40758989, 40759953, 40760436, 40760833, 43022052, 43054893, 43530886, 43530888, 4014769, 4060556, 4060559
								)
						)
					AND po.procedure_concept_id NOT IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (4060559, 4060556, 4014769)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				m.measurement_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.measurement m
				ON c.subject_id = m.person_id
					AND m.measurement_date <= c.cohort_start_date
					AND m.measurement_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND m.measurement_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								72693, 72696, 72973, 73268, 73282, 75639, 76491, 76756, 77338, 77619, 78210, 78218, 79091, 79146, 79890, 80165, 80204, 80205, 80463, 81358, 81360, 81636, 133284, 135370, 139895, 192380, 192385, 193525, 193825, 194598, 195877, 197050, 198212, 201091, 201958, 258564, 313590, 314099, 315884, 375016, 432969, 433027, 433603, 433880, 434697, 435875, 435887, 436219, 437041, 437090, 437341, 437937, 439656, 440162, 440216, 441092, 441682, 441926, 441959, 442088, 442772, 443213, 443214, 443295, 2004764, 2004822, 2004823, 2004824, 2100998, 2101804, 2110280, 2110284, 2110285, 2110288, 2110304, 2110305, 2110337, 2110340, 2211758, 2211759, 2211760, 2211761, 2211782, 2211785, 2212094, 2212144, 2212145, 2212210, 2212334, 2212391, 2212436, 2212438, 2212439, 2212713, 2212714, 2213361, 2213362, 2213363, 2213364, 2213365, 3000119, 3002091, 3003191, 3003262, 3003694, 3004303, 3005625, 3006511, 3006722, 3008714, 3009417, 3010164, 3011149, 3011465, 3011536, 3011996, 3013297, 3014064, 3017439, 3018171, 3018954, 3019145, 3021584, 3023524, 3023791, 3025455, 3025994, 3030662, 3034139, 3035904, 3036988, 
								3038136, 3040000, 3044819, 3045823, 3051741, 4014290, 4015137, 4015139, 4015159, 4015304, 4015590, 4016059, 4023420, 4030415, 4034308, 4038424, 4038571, 4038573, 4038747, 4038759, 4038937, 4038938, 4038939, 4038942, 4038945, 4039088, 4039609, 4039610, 4041161, 4047845, 4053583, 4057149, 4058246, 4059050, 4059478, 4059984, 4060098, 4060105, 4060240, 4060252, 4060255, 4060259, 4060424, 4060672, 4061154, 4061411, 4061423, 4061522, 4061530, 4061672, 4061791, 4061793, 4061795, 4062361, 4062565, 4064169, 4064277, 4064854, 4066111, 4066354, 4070303, 4071437, 4072421, 4072862, 4079751, 4079835, 4079844, 4080059, 4080067, 4081196, 4081292, 4083415, 4084186, 4084521, 4084693, 4087235, 4092289, 4094910, 4098631, 4120817, 4120986, 4127104, 4127241, 4129023, 4130310, 4133029, 4140250, 4143204, 4143646, 4145315, 4146482, 4147941, 4148890, 4149370, 4149783, 4150421, 4150948, 4151190, 4151412, 4156955, 4163851, 4171428, 4173786, 4175225, 4176966, 4186424, 4190427, 4194143, 4199599, 4199931, 4207466, 4210896, 4212260, 4214930, 4218813, 4232703, 4239302, 4260976, 4285271, 4299535, 4305717
								, 4327048, 4334808, 40479820, 40756825, 40758989, 40759953, 40760436, 40760833, 43022052, 43054893, 43530886, 43530888, 4014769, 4060556, 4060559
								)
						)
					AND m.measurement_concept_id NOT IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (4060559, 4060556, 4014769)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				o.observation_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.observation o
				ON c.subject_id = o.person_id
					AND o.observation_date <= c.cohort_start_date
					AND o.observation_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND o.observation_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								72693, 72696, 72973, 73268, 73282, 75639, 76491, 76756, 77338, 77619, 78210, 78218, 79091, 79146, 79890, 80165, 80204, 80205, 80463, 81358, 81360, 81636, 133284, 135370, 139895, 192380, 192385, 193525, 193825, 194598, 195877, 197050, 198212, 201091, 201958, 258564, 313590, 314099, 315884, 375016, 432969, 433027, 433603, 433880, 434697, 435875, 435887, 436219, 437041, 437090, 437341, 437937, 439656, 440162, 440216, 441092, 441682, 441926, 441959, 442088, 442772, 443213, 443214, 443295, 2004764, 2004822, 2004823, 2004824, 2100998, 2101804, 2110280, 2110284, 2110285, 2110288, 2110304, 2110305, 2110337, 2110340, 2211758, 2211759, 2211760, 2211761, 2211782, 2211785, 2212094, 2212144, 2212145, 2212210, 2212334, 2212391, 2212436, 2212438, 2212439, 2212713, 2212714, 2213361, 2213362, 2213363, 2213364, 2213365, 3000119, 3002091, 3003191, 3003262, 3003694, 3004303, 3005625, 3006511, 3006722, 3008714, 3009417, 3010164, 3011149, 3011465, 3011536, 3011996, 3013297, 3014064, 3017439, 3018171, 3018954, 3019145, 3021584, 3023524, 3023791, 3025455, 3025994, 3030662, 3034139, 3035904, 3036988, 
								3038136, 3040000, 3044819, 3045823, 3051741, 4014290, 4015137, 4015139, 4015159, 4015304, 4015590, 4016059, 4023420, 4030415, 4034308, 4038424, 4038571, 4038573, 4038747, 4038759, 4038937, 4038938, 4038939, 4038942, 4038945, 4039088, 4039609, 4039610, 4041161, 4047845, 4053583, 4057149, 4058246, 4059050, 4059478, 4059984, 4060098, 4060105, 4060240, 4060252, 4060255, 4060259, 4060424, 4060672, 4061154, 4061411, 4061423, 4061522, 4061530, 4061672, 4061791, 4061793, 4061795, 4062361, 4062565, 4064169, 4064277, 4064854, 4066111, 4066354, 4070303, 4071437, 4072421, 4072862, 4079751, 4079835, 4079844, 4080059, 4080067, 4081196, 4081292, 4083415, 4084186, 4084521, 4084693, 4087235, 4092289, 4094910, 4098631, 4120817, 4120986, 4127104, 4127241, 4129023, 4130310, 4133029, 4140250, 4143204, 4143646, 4145315, 4146482, 4147941, 4148890, 4149370, 4149783, 4150421, 4150948, 4151190, 4151412, 4156955, 4163851, 4171428, 4173786, 4175225, 4176966, 4186424, 4190427, 4194143, 4199599, 4199931, 4207466, 4210896, 4212260, 4214930, 4218813, 4232703, 4239302, 4260976, 4285271, 4299535, 4305717
								, 4327048, 4334808, 40479820, 40756825, 40758989, 40759953, 40760436, 40760833, 43022052, 43054893, 43530886, 43530888, 4014769, 4060556, 4060559
								)
						)
					AND o.observation_concept_id NOT IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (4060559, 4060556, 4014769)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}

			) t
		GROUP BY row_id
		) t2
		ON t1.row_id = t2.row_id
	LEFT JOIN
		--no outcome after marker and before index
		(
		SELECT row_id,
			MAX(preg_event_date) AS preg_event_date
		FROM (
			SELECT @row_id_field AS row_id,
				co.condition_start_date AS preg_event_date
			FROM  @cohort_temp_table c
			INNER JOIN @cdm_database_schema.condition_occurrence co
				ON c.subject_id = co.person_id
					AND co.condition_start_date <= c.cohort_start_date
					AND co.condition_start_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND co.condition_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				po.procedure_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.procedure_occurrence po
				ON c.subject_id = po.person_id
					AND po.procedure_date <= c.cohort_start_date
					AND po.procedure_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND po.procedure_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				m.measurement_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.measurement m
				ON c.subject_id = m.person_id
					AND m.measurement_date <= c.cohort_start_date
					AND m.measurement_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND m.measurement_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				o.observation_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.observation o
				ON c.subject_id = o.person_id
					AND o.observation_date <= c.cohort_start_date
					AND o.observation_date >= dateadd(dd, - 270, c.cohort_start_date)
					AND o.observation_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}

			) t
		GROUP BY row_id
		) t3
		ON t2.row_id = t3.row_id
			AND t3.preg_event_date >= t2.preg_event_date
	INNER JOIN
		--at least one outcome marker within 9o after index
		(
		SELECT row_id,
			MAX(preg_event_date) AS preg_event_date
		FROM (
			SELECT @row_id_field AS row_id,
				co.condition_start_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.condition_occurrence co
				ON c.subject_id = co.person_id
					AND co.condition_start_date >= c.cohort_start_date
					AND co.condition_start_date <= dateadd(dd, - 270, c.cohort_start_date)
					AND co.condition_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				po.procedure_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.procedure_occurrence po
				ON c.subject_id = po.person_id
					AND po.procedure_date >= c.cohort_start_date
					AND po.procedure_date <= dateadd(dd, 270, c.cohort_start_date)
					AND po.procedure_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				m.measurement_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.measurement m
				ON c.subject_id = m.person_id
					AND m.measurement_date >= c.cohort_start_date
					AND m.measurement_date <= dateadd(dd, 270, c.cohort_start_date)
					AND m.measurement_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}
			
			UNION
			
			SELECT @row_id_field AS row_id,
				o.observation_date AS preg_event_date
			FROM @cohort_temp_table c
			INNER JOIN @cdm_database_schema.observation o
				ON c.subject_id = o.person_id
					AND o.observation_date >= c.cohort_start_date
					AND o.observation_date >= dateadd(dd, 270, c.cohort_start_date)
					AND o.observation_concept_id IN (
						SELECT descendant_concept_id
						FROM @cdm_database_schema.concept_ancestor
						WHERE ancestor_concept_id IN (
								23034, 72692, 72697, 72970, 73019, 73267, 73538, 73546, 73824, 74469, 74698, 75605, 76221, 76533, 76761, 76771, 77052, 77615, 77621, 77624, 79889, 79897, 80471, 80778, 80782, 81086, 81357, 133816, 134414, 135601, 136755, 137099, 137940, 137974, 138207, 138484, 141639, 192972, 193264, 193271, 193323, 193539, 193544, 194694, 194702, 194707, 195064, 195075, 195878, 196170, 196181, 197043, 197048, 197049, 197349, 197625, 197930, 198216, 198486, 198816, 198870, 200524, 201359, 201368, 201681, 252442, 260212, 312733, 314103, 317669, 318247, 318856, 319138, 320456, 321367, 321683, 373870, 380533, 432396, 432429, 432441, 432443, 432695, 432734, 432968, 433274, 433309, 433314, 433542, 433604, 433869, 433873, 434154, 434167, 434427, 434474, 434482, 434744, 435026, 435323, 435325, 435359, 435369, 435606, 435656, 435879, 435917, 436171, 436173, 436477, 436489, 436517, 436532, 437061, 437369, 437611, 437936, 437976, 438206, 438490, 438541, 439077, 439140, 439149, 439156, 439402, 439923, 440161, 440166, 440203, 440211, 440218, 440464, 440465, 440481, 440795, 440829, 440833, 440840, 441082, 441128, 441364, 
								441369, 441412, 441630, 441644, 441649, 441964, 442058, 442082, 442148, 442216, 442300, 442631, 442777, 442915, 442917, 442919, 442920, 442922, 442923, 443054, 443133, 443242, 443243, 443246, 443249, 443263, 443330, 443522, 443523, 443618, 2004306, 2004362, 2004526, 2004546, 2004809, 2004826, 2004828, 2004829, 2004830, 2004842, 2004843, 2004844, 2004845, 2004846, 2004862, 2101806, 2101807, 2101808, 2101809, 2101811, 2101813, 2101814, 2106488, 2108149, 2110084, 2110236, 2110281, 2110286, 2110287, 2110296, 2110299, 2110314, 2110325, 2110326, 2110327, 2110328, 2110339, 2514555, 2514556, 2514557, 2514558, 2514560, 2514563, 2514564, 2514569, 2514570, 2514571, 2514572, 2514576, 2721181, 3002574, 3003857, 3004221, 3004943, 3016704, 4001541, 4003030, 4014291, 4014304, 4014439, 4014445, 4014446, 4014451, 4014452, 4014465, 4014719, 4014738, 4015143, 4015144, 4015152, 4015154, 4015277, 4015410, 4015415, 4016060, 4016064, 4016464, 4016476, 4028640, 4028644, 4028781, 4034146, 4034153, 4034650, 4038495, 4047937, 4055924, 4057976, 4058243, 4058403, 4061471, 4062356, 4062362, 4062811, 
								4063159, 4063171, 4063296, 4063697, 4064171, 4064174, 4064177, 4066258, 4067106, 4069972, 4071063, 4071642, 4073719, 4074426, 4074443, 4074867, 4075159, 4075176, 4079843, 4079844, 4079860, 4081774, 4084845, 4086797, 4089029, 4092760, 4107728, 4113503, 4114280, 4116804, 4118056, 4122728, 4128030, 4132649, 4138740, 4140071, 4143292, 4145316, 4145318, 4148097, 4150401, 4150640, 4151029, 4151903, 4152029, 4152444, 4152967, 4153287, 4155282, 4161205, 4162866, 4169915, 4170121, 4170151, 4170305, 4174302, 4187201, 4190767, 4192676, 4194423, 4195545, 4203918, 4215564, 4240605, 4248954, 4253751, 4260748, 4260749, 4263669, 4297232, 4297250, 4309425, 4311671, 4336229, 4340944, 4345685, 40479783, 40483251, 40484589, 40485007, 40485049, 40759177, 40760193, 40766616, 40767416, 42742390
								)
						)
{@cohort_id != -1} ? {			WHERE c.cohort_definition_id = @cohort_id}

			) t
		GROUP BY row_id
		) t4
		ON t1.row_id = t4.row_id
	WHERE t3.row_id IS NULL
	) tmp;

--4.  children (age<18)
SELECT DISTINCT row_id,
	CAST(4000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_4
FROM (
	SELECT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.person p
		ON c.subject_id = p.person_id
	WHERE YEAR(c.cohort_start_date) - p.year_of_birth < 18
{@cohort_id != -1} ? {		AND c.cohort_definition_id = @cohort_id}	
	) tmp;

--5.  elderly (age >= 65)
SELECT DISTINCT row_id,
	CAST(5000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_5
FROM (
	SELECT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.person p
		ON c.subject_id = p.person_id
	WHERE YEAR(c.cohort_start_date) - p.year_of_birth >= 65
{@cohort_id != -1} ? {		AND c.cohort_definition_id = @cohort_id}	
	) tmp;

--6. female
SELECT DISTINCT row_id,
	CAST(6000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_6	
FROM (
	SELECT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.person p
		ON c.subject_id = p.person_id
			AND p.gender_concept_id = 8532
{@cohort_id != -1} ? {		AND c.cohort_definition_id = @cohort_id}	
	) tmp;
	
--7. Type 2 diabetes mellitus
CREATE TABLE #codesets (
	codeset_id INT NOT NULL,
	concept_id BIGINT NOT NULL
	);

--Concept set 4: Type 2 diabetes mellitus 
INSERT INTO #codesets (
	codeset_id,
	concept_id
	)
SELECT 4 AS codeset_id,
	c.concept_id
FROM (
	SELECT DISTINCT I.concept_id
	FROM (
		SELECT concept_id
		FROM @cdm_database_schema.concept
		WHERE concept_id IN (443735, 443767, 192279, 443732, 376065, 443729, 201826)
			AND invalid_reason IS NULL
		
		UNION
		
		SELECT c.concept_id
		FROM @cdm_database_schema.concept c
		JOIN @cdm_database_schema.concept_ancestor ca
			ON c.concept_id = ca.descendant_concept_id
				AND ca.ancestor_concept_id IN (443735, 443767, 192279, 443732, 376065, 443729, 201826)
				AND c.invalid_reason IS NULL
		) I
	LEFT JOIN (
		SELECT concept_id
		FROM @cdm_database_schema.concept
		WHERE concept_id IN (4225656, 4227210, 435216, 37016355, 4228112, 4224254, 200687, 201254, 201531, 4295011)
			AND invalid_reason IS NULL
		
		UNION
		
		SELECT c.concept_id
		FROM @cdm_database_schema.concept c
		JOIN @cdm_database_schema.concept_ancestor ca
			ON c.concept_id = ca.descendant_concept_id
				AND ca.ancestor_concept_id IN (4225656, 4227210, 435216, 37016355, 4228112, 4224254, 200687, 201254, 201531, 4295011)
				AND c.invalid_reason IS NULL
		) e
		on i.concept_id = e.concept_id
	WHERE E.concept_id IS NULL
	) c;

-- Concept set 5: Drugs to treat Type 2 Diabetes Mellitus excluding insulin
INSERT INTO #codesets (
	codeset_id,
	concept_id
	)
SELECT 5 AS codeset_id,
	c.concept_id
FROM (
	SELECT DISTINCT I.concept_id
	FROM (
		SELECT concept_id
		FROM @cdm_database_schema.concept
		WHERE concept_id IN (21600744)
			AND invalid_reason IS NULL
		
		UNION
		
		SELECT c.concept_id
		FROM @cdm_database_schema.concept c
		JOIN @cdm_database_schema.concept_ancestor ca
			ON c.concept_id = ca.descendant_concept_id
				AND ca.ancestor_concept_id IN (21600744)
				AND c.invalid_reason IS NULL
		) i
	) c;

-- Concept set 6: Hemoglobin A1c measurement
INSERT INTO #codesets (
	codeset_id,
	concept_id
	)
SELECT 6 AS codeset_id,
	c.concept_id
FROM (
	SELECT DISTINCT I.concept_id
	FROM (
		SELECT concept_id
		FROM @cdm_database_schema.concept
		WHERE concept_id IN (4197971, 44786901, 3004410, 3034639, 40758583, 3007263, 3003309, 3005673, 40762352, 2212392)
			AND invalid_reason IS NULL
		) i
	) c;
	
SELECT @row_id_field AS row_id,
	person_id,
	condition_start_date
INTO #initial_cohort
FROM @cohort_temp_table c
INNER JOIN @cdm_database_schema.condition_occurrence co
	ON c.subject_id = co.person_id
		AND co.condition_start_date <= DATEADD(DAY, @window_end, c.cohort_start_date)
		AND co.condition_start_date >= DATEADD(DAY, @window_start, c.cohort_start_date)
		AND co.condition_concept_id IN (SELECT concept_id FROM #codesets WHERE codeset_id = 4)
{@cohort_id != -1} ? {WHERE c.cohort_definition_id = @cohort_id}		
;

SELECT DISTINCT row_id,
	CAST(7000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_7	
FROM (
	SELECT row_id
	FROM #initial_cohort c
	INNER JOIN @cdm_database_schema.condition_occurrence co2
		ON c.person_id = co2.person_id
		AND co2.condition_start_date > c.condition_start_date 
		AND co2.condition_concept_id IN (SELECT concept_id FROM #codesets WHERE codeset_id = 4)	
		
	UNION ALL
	
	SELECT row_id
	FROM #initial_cohort c
	INNER JOIN @cdm_database_schema.drug_exposure de
		ON c.person_id = de.person_id
		AND de.drug_exposure_start_date >= c.condition_start_date 
		AND de.drug_concept_id IN (SELECT concept_id FROM #codesets WHERE codeset_id = 5)	
	INNER JOIN @cdm_database_schema.drug_exposure de2
		ON c.person_id = de2.person_id
		AND de2.drug_exposure_start_date > de.drug_exposure_start_date
		AND de2.drug_concept_id IN (SELECT concept_id FROM #codesets WHERE codeset_id = 5)	

	UNION ALL
	
	SELECT row_id
	FROM #initial_cohort c
	INNER JOIN @cdm_database_schema.measurement me
		ON c.person_id = me.person_id
		AND me.measurement_date >= c.condition_start_date 
		AND me.measurement_concept_id IN (SELECT concept_id FROM #codesets WHERE codeset_id = 6)	
		AND me.value_as_number >= 6.5
		AND me.value_as_number <= 30.0
		AND me.unit_concept_id = 8554
	INNER JOIN @cdm_database_schema.measurement me2
		ON c.person_id = me2.person_id
		AND me2.measurement_date > me.measurement_date
		AND me2.measurement_concept_id IN (SELECT concept_id FROM #codesets WHERE codeset_id = 6)	
		AND  me2.value_as_number >= 6.5
		AND me2.value_as_number <= 30.0
		AND me2.unit_concept_id = 8554
	) tmp;
	
	
TRUNCATE TABLE #codesets;

DROP TABLE #codesets;

TRUNCATE TABLE #initial_cohort;

DROP TABLE #initial_cohort;

--8.  black or african american
SELECT DISTINCT row_id,
	CAST(8000 + @analysis_id AS BIGINT) AS covariate_id,
	1 AS covariate_value
INTO #cov_8
FROM (
	SELECT @row_id_field AS row_id
	FROM @cohort_temp_table c
	INNER JOIN @cdm_database_schema.person p
		ON c.subject_id = p.person_id
			AND p.race_concept_id IN (8516, 38003598, 38003599, 38003600)
	) tmp;
